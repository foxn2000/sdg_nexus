# 三次元スケーリング推論エージェント

## 概要

三次元スケーリング推論エージェントは、LLMの能力を最大化するために**3つのスケーリング軸**を活用した高度な推論システムです。

```
┌─────────────────────────────────────────────────────────────┐
│                    三次元スケーリング                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     推論時間                                                 │
│        │                                                    │
│        │    ┌──────────────────────────────┐               │
│        │    │                              │               │
│        ▼    │      最適な推論空間          │               │
│    ┌───────────────────────┐              │               │
│    │   │   │   │   │       │              │               │
│    │   │   │ ● │   │       │──────────────┤               │
│    │   │   │   │   │       │              │               │
│    └───────────────────────┘              │               │
│                │            │              │               │
│                │            └──────────────┘               │
│                │                 ▲                         │
│                ▼                 │                         │
│           並列数 ──────────────► モデル性能                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 三次元スケーリングの軸

### 1. 推論時間（Inference Time Scaling）

反復回数と各ステップの深さを制御します。

- **最大反復回数**: 5回
- **評価ベース**: 品質スコアが70点以上になるまで反復
- **適応的停止**: 十分な品質に達したら早期終了

### 2. モデル性能（Model Performance Scaling）

プロンプトで制御する推論エフォート（reasoning effort）を調整します。

| エフォート | 説明 | 回答長 | 適用場面 |
|-----------|------|--------|---------|
| **low** | 簡潔で要点のみ | 100-200字 | 単純な質問、広く浅い質問 |
| **medium** | バランスの取れた詳細度 | 200-400字 | 一般的な質問 |
| **high** | 詳細な分析と根拠 | 400-800字 | 複雑な質問、深く狭い質問 |

### 3. 並列数（Parallel Processing Scaling）

同時に検討する視点の数を制御します。

- **最大並列数**: 10個
- **動的調整**: 質問タイプに応じて自動決定
  - 広く浅い質問 → 6-10視点
  - 深く狭い質問 → 2-4視点
  - 複合的な質問 → 4-6視点

## 処理フロー

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌─────────────┐                                                │
│  │  質問入力   │                                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │  ① 難易度・特性判定                      │                    │
│  │  - 質問タイプ判定                        │                    │
│  │  - 推論エフォート決定                    │                    │
│  │  - 並列数決定                            │                    │
│  └──────┬──────────────────────────────────┘                    │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │  ② 視点分割・プロンプト生成             │                    │
│  │  - N個の視点を生成                       │                    │
│  │  - 各視点に対応するプロンプト作成        │                    │
│  └──────┬──────────────────────────────────┘                    │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │  ③ 並列推論処理                          │                    │
│  │  ┌─────┬─────┬─────┬─────┬─────┐        │                    │
│  │  │視点1│視点2│視点3│ ... │視点N│        │                    │
│  │  └──┬──┴──┬──┴──┬──┴─────┴──┬──┘        │                    │
│  │     │     │     │           │           │                    │
│  │     ▼     ▼     ▼           ▼           │                    │
│  │  [回答1][回答2][回答3] ... [回答N]       │                    │
│  └──────┬──────────────────────────────────┘                    │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │  ④ 結果統合・品質評価                    │                    │
│  │  - 回答の統合                            │                    │
│  │  - 品質スコア算出（0-100）               │                    │
│  │  - 不足部分の特定                        │                    │
│  └──────┬──────────────────────────────────┘                    │
│         │                                                        │
│         ├──────< 品質 < 70点 かつ 反復 < 5回 >──────┐            │
│         │                                          │            │
│         │                         ┌────────────────▼─────────┐  │
│         │                         │  追加推論                │  │
│         │                         │  - 不足部分を補完        │  │
│         │                         │  - 既存回答とマージ      │  │
│         │                         └────────────────┬─────────┘  │
│         │                                          │            │
│         │◀─────────────────────────────────────────┘            │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │  ⑤ 回答の総合化                         │                    │
│  │  - 論理的構造化                          │                    │
│  │  - 明確化                                │                    │
│  └──────┬──────────────────────────────────┘                    │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │  ⑥ 校正・最終回答作成                   │                    │
│  │  - 正確性チェック                        │                    │
│  │  - 一貫性チェック                        │                    │
│  │  - 最終整形                              │                    │
│  └──────┬──────────────────────────────────┘                    │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │  最終回答出力 │                                                │
│  └─────────────┘                                                │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 使用方法

### 基本的な実行

```bash
python -m sdg run \
  --yaml examples/3d_scaling_agent.yaml \
  --input examples/data/3d_scaling_input.jsonl \
  --output output/3d_scaling_result.jsonl \
  --save-intermediate
```

### 入力データ形式

JSON Lines形式で、`question`フィールドに質問を記述します。

```jsonl
{"question": "人工知能とは何ですか？その歴史、現在の応用例、そして将来の可能性について教えてください。"}
{"question": "ニューラルネットワークにおけるバックプロパゲーションアルゴリズムの数学的原理を詳細に説明してください。"}
```

### 出力データ

出力には以下の情報が含まれます：

| フィールド | 説明 |
|-----------|------|
| `final_answer` | 最終的な回答 |
| `question_type` | 質問タイプ（broad_shallow/deep_narrow/composite） |
| `difficulty_level` | 難易度（1-5） |
| `reasoning_effort` | 推論エフォート（low/medium/high） |
| `parallel_count` | 使用した視点数 |
| `iteration_count` | 実行した反復回数 |
| `quality_score` | 品質スコア（0-100） |
| `formatted_result` | 詳細なフォーマット済み結果 |

## 質問タイプと推論戦略

### 広く浅い質問（Broad-Shallow）

**特徴**: 複数の側面を概観的に扱う  
**例**: 「〇〇について教えてください」「〇〇の概要を説明して」

**推論戦略**:
- 推論エフォート: low または medium
- 並列数: 6-10（多くの視点から概観）
- 各回答: 簡潔

### 深く狭い質問（Deep-Narrow）

**特徴**: 特定のトピックを深く掘り下げる  
**例**: 「〇〇の原理を詳細に説明して」「〇〇の数学的背景を論じて」

**推論戦略**:
- 推論エフォート: high
- 並列数: 2-4（少ない視点で深く）
- 各回答: 詳細

### 複合的な質問（Composite）

**特徴**: 複数の要素を組み合わせた質問  
**例**: 「〇〇と〇〇の関係を説明し、実際の応用例を挙げて」

**推論戦略**:
- 推論エフォート: medium または high
- 並列数: 4-6（バランス）
- 各回答: 中程度の詳細度

## 視点の種類

以下の10種類の視点から、質問に応じて適切なものが選択されます：

1. **事実・定義**: 基本的な事実や定義を確認
2. **原因・理由**: なぜそうなるのかを分析
3. **方法・プロセス**: どのように行うかを説明
4. **比較・対照**: 類似・対立概念との比較
5. **影響・結果**: 結果や波及効果を検討
6. **歴史・背景**: 時間軸での発展や背景
7. **実例・応用**: 具体的な事例や応用場面
8. **批判・限界**: 問題点や限界の検討
9. **将来・展望**: 今後の可能性や発展
10. **統合・総括**: 全体を俯瞰した視点

## 品質評価基準

統合された回答は以下の基準で評価されます（各25点、合計100点）：

| 基準 | 説明 |
|------|------|
| **網羅性** | 質問のすべての側面がカバーされているか |
| **深さ** | 十分な詳細度と分析の深さがあるか |
| **整合性** | 論理的な一貫性があるか |
| **明確性** | 回答が明確で理解しやすいか |

**品質スコアの解釈**:
- 70点以上: 十分な品質（追加推論不要）
- 70点未満: 不足部分あり（追加推論を実行）

## 設定のカスタマイズ

### グローバル定数

```yaml
globals:
  const:
    MAX_ITERATIONS: 5    # 最大反復回数
    MAX_PARALLEL: 10     # 最大並列数
```

### 予算設定

```yaml
budgets:
  loops:
    max_iters: 100       # ループの最大反復
  wall_time_ms: 900000   # 最大実行時間（15分）
  ai:
    max_calls: 100       # AIブロックの最大呼び出し回数
    max_tokens: 500000   # 最大トークン数
```

## 技術的な詳細

### 使用モデル

このエージェントは単一のモデル（qwen3）のみを使用し、プロンプトの指示によって推論エフォートを制御します。

```yaml
models:
  - name: qwen3
    api_model: qwen3
    api_key: "sk-local"
    base_url: http://localhost:8000/v1
```

### 条件付き実行

各並列推論ブロックは`run_if`条件で制御され、必要な視点数に応じて実行されます：

```yaml
run_if:
  gte: ["{ActualParallelCount}", 3]  # 並列数が3以上の場合のみ実行
```

## 関連ファイル

- **YAMLファイル**: `examples/3d_scaling_agent.yaml`
- **ヘルパー関数**: `examples/helpers/format_helpers.py`
- **入力データ**: `examples/data/3d_scaling_input.jsonl`

## 理論的背景

このアプローチは以下の研究トレンドに基づいています：

1. **Test-time Compute Scaling**: OpenAI o1/o3、DeepSeek R1などで実証された推論時間スケーリング
2. **Scaling Laws**: モデルサイズと性能の関係を示すスケーリング法則
3. **Multi-Agent Systems**: 複数の視点からの推論を統合するマルチエージェントアプローチ
4. **Self-Consistency**: 複数の推論パスを生成して統合する手法