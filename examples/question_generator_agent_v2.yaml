# LLMベンチマーク用質問生成エージェント v2
# 資料から独立して成立する質問文を生成し、4つの質問を個別に評価
# v2の改善点:
#   - 各プロンプトを個別に評価し「使用可能」/「使用不可」を判定
#   - 4つのプロンプトに対してそれぞれ専用の異なる進化プロンプトを使用

mabel:
  version: "2.0"
  id: "com.example.agent.question_generator_v2"
  name: "LLM Benchmark Question Generator Agent v2"
  description: |
    資料を参照して質問の原型を作成し、多角化・個別進化・個別検証を経て
    複数のLLMベンチマーク用質問を生成するエージェント（v2: 個別評価対応）

# モデル設定（qwen3 - 出力形式: <think>思考</think>回答）
models:
  - name: qwen3
    api_model: "qwen3"
    api_key: "sk-local"
    base_url: http://localhost:11434/v1
    request_defaults:
      temperature: 0.7
      max_tokens: 4096
      top_p: 0.9

# グローバル変数
globals:
  const:
    NUM_DIVERSIFIED_QUESTIONS: 4
    APP_NAME: "LLM Benchmark Question Generator v2"
  vars:
    original_question: ""
    diversified_questions: ""
    # 各質問の進化結果
    evolved_question1: ""
    evolved_question2: ""
    evolved_question3: ""
    evolved_question4: ""
    # 各質問の評価結果
    is_valid1: false
    is_valid2: false
    is_valid3: false
    is_valid4: false

# 予算設定
budgets:
  loops:
    max_iters: 20
    on_exceed: "truncate"
  recursion:
    max_depth: 16
    on_exceed: "error"
  wall_time_ms: 900000
  ai:
    max_calls: 30
    max_tokens: 100000

blocks:
  # ============================================================
  # ステップ1: 資料に基づく質問の原型作成
  # ============================================================
  - type: ai
    exec: 10
    id: create_original_question
    name: "Step 1: Create Original Question from Source"
    model: qwen3
    system_prompt: |
      あなたは教育・評価用の質問を作成する専門家です。
      与えられた資料を分析し、その内容に基づいて「質問の原型」を1つ作成してください。
      
      【重要なルール】
      1. 質問は資料の内容を参考にするが、資料なしでも回答できる形式にすること
      2. 「資料によると」「上記の文章では」などの資料参照表現は絶対に使用しないこと
      3. 質問は一般的な知識や論理的思考で回答可能な形式にすること
      4. 質問は具体的で明確であること
      
      【出力形式】
      <think>資料の分析と質問設計の思考プロセス</think>
      <question>生成した質問文</question>
      <topic>質問の主題（キーワード）</topic>
    prompts:
      - |
        以下の資料を参考にして、LLM評価用の質問の原型を1つ作成してください。
        
        【資料】
        {text}
        
        注意: 生成する質問は資料を読まなくても回答できる一般的な質問形式にしてください。
    outputs:
      - name: OriginalQuestion
        select: tag
        tag: question
      - name: QuestionTopic
        select: tag
        tag: topic
      - name: Step1Thinking
        select: tag
        tag: think
    save_to:
      vars:
        original_question: OriginalQuestion

  # ============================================================
  # ステップ2: 質問文の多角化（4つの視点追加）
  # ============================================================
  - type: ai
    exec: 20
    id: diversify_questions
    name: "Step 2: Diversify Questions (4 Perspectives)"
    model: qwen3
    system_prompt: |
      あなたは多角的な視点から質問を設計する専門家です。
      与えられた原型質問を基に、異なる角度・切り口から4つの新しい質問を作成してください。
      
      【4つの視点 - 必ずこの順序で出力してください】
      1. 原因・理由を問う視点（なぜ〜か？）
      2. 方法・プロセスを問う視点（どのように〜か？）
      3. 比較・対照の視点（〜と〜の違いは？）
      4. 影響・結果を問う視点（〜の影響は？）
      
      【重要なルール】
      1. 各質問は資料なしで単独で成立すること
      2. 「資料によると」などの参照表現は禁止
      3. 4つの質問はそれぞれ異なる視点・切り口であること
      4. 質問は番号付きリスト形式で出力すること
      
      【出力形式】
      <think>多角化の思考プロセス</think>
      <questions>
      1. [原因・理由] 質問文1
      2. [方法・プロセス] 質問文2
      3. [比較・対照] 質問文3
      4. [影響・結果] 質問文4
      </questions>
    prompts:
      - |
        以下の原型質問を基に、4つの異なる視点から質問を作成してください。
        
        【原型質問】
        {OriginalQuestion}
        
        【主題】
        {QuestionTopic}
        
        それぞれの質問は、単独で成立し、資料なしでも回答可能な形式にしてください。
    outputs:
      - name: DiversifiedQuestions
        select: tag
        tag: questions
      - name: Step2Thinking
        select: tag
        tag: think
    save_to:
      vars:
        diversified_questions: DiversifiedQuestions

  # ============================================================
  # ステップ3: 多角化された質問を4つに分離
  # ============================================================
  - type: python
    exec: 30
    id: split_questions
    name: "Step 3: Split Questions into 4"
    function: split_diversified_questions
    code_path: ./examples/helpers.py
    inputs:
      diversified_questions: "{DiversifiedQuestions}"
    outputs: [Question1, Question2, Question3, Question4]
    use_env: "global"
    ctx_access: ["vars.read", "log"]

  # ============================================================
  # ステップ4: 各質問の個別進化（4つの異なる進化プロンプト）
  # ============================================================

  # --- 質問1の進化: 原因・理由の視点 → 深い考察と根拠を求める ---
  - type: ai
    exec: 41
    id: evolve_question1
    name: "Step 4-1: Evolve Question 1 (Cause & Reason - Deep Analysis)"
    model: qwen3
    system_prompt: |
      あなたは「原因・理由」を探求する質問の専門家です。
      与えられた質問を、以下の方向性で進化させてください：
      
      【進化の方向性：深い考察と根拠の要求】
      1. 表面的な理由だけでなく、根本的な原因に迫る質問に変換
      2. 複数の要因や背景を検討するよう促す
      3. 論理的な根拠や証拠を求める形式に発展
      4. 「なぜそうなるのか」の理由を段階的に掘り下げる
      
      【人間らしさの付与】
      - 実際の業務や研究場面を想定した文脈を追加
      - 具体的な状況設定を付与
      - 自然な話し言葉的表現に調整
      
      【重要なルール】
      - 質問は資料なしで単独で成立すること
      - 複雑になっても回答可能な範囲に留めること
      
      【出力形式】
      <think>進化の思考プロセス</think>
      <evolved>進化後の質問文</evolved>
    prompts:
      - |
        以下の「原因・理由」視点の質問を進化させてください。
        
        【元の質問】
        {Question1}
        
        【主題】
        {QuestionTopic}
        
        深い考察と根拠を求める形式に発展させ、人間らしい表現に変換してください。
    outputs:
      - name: EvolvedQuestion1
        select: tag
        tag: evolved
      - name: Evolve1Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question1: EvolvedQuestion1

  # --- 質問2の進化: 方法・プロセスの視点 → 実践的な手順と応用 ---
  - type: ai
    exec: 42
    id: evolve_question2
    name: "Step 4-2: Evolve Question 2 (Method & Process - Practical Application)"
    model: qwen3
    system_prompt: |
      あなたは「方法・プロセス」を設計する質問の専門家です。
      与えられた質問を、以下の方向性で進化させてください：
      
      【進化の方向性：実践的な手順と応用】
      1. 具体的な手順やステップを求める形式に変換
      2. 実際の適用場面や条件を想定した質問に発展
      3. 注意点や落とし穴についても言及を求める
      4. 効率的なアプローチや代替案の検討を促す
      
      【人間らしさの付与】
      - 「初めて取り組む人」や「実務者」の視点を追加
      - 具体的な制約条件（時間、リソース等）を設定
      - 自然な話し言葉的表現に調整
      
      【重要なルール】
      - 質問は資料なしで単独で成立すること
      - 複雑になっても回答可能な範囲に留めること
      
      【出力形式】
      <think>進化の思考プロセス</think>
      <evolved>進化後の質問文</evolved>
    prompts:
      - |
        以下の「方法・プロセス」視点の質問を進化させてください。
        
        【元の質問】
        {Question2}
        
        【主題】
        {QuestionTopic}
        
        実践的な手順と応用を求める形式に発展させ、人間らしい表現に変換してください。
    outputs:
      - name: EvolvedQuestion2
        select: tag
        tag: evolved
      - name: Evolve2Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question2: EvolvedQuestion2

  # --- 質問3の進化: 比較・対照の視点 → 多角的分析と違いの明確化 ---
  - type: ai
    exec: 43
    id: evolve_question3
    name: "Step 4-3: Evolve Question 3 (Comparison - Multi-angle Analysis)"
    model: qwen3
    system_prompt: |
      あなたは「比較・対照」分析の質問の専門家です。
      与えられた質問を、以下の方向性で進化させてください：
      
      【進化の方向性：多角的分析と違いの明確化】
      1. 単純な違いだけでなく、共通点と相違点の両方を求める
      2. 比較の観点・基準を明確にする形式に変換
      3. それぞれの長所・短所の分析を促す
      4. 状況に応じた適切な選択の判断基準を求める
      
      【人間らしさの付与】
      - 実際の選択場面や意思決定を想定
      - 具体的な評価軸（コスト、効率、品質等）を設定
      - 自然な話し言葉的表現に調整
      
      【重要なルール】
      - 質問は資料なしで単独で成立すること
      - 複雑になっても回答可能な範囲に留めること
      
      【出力形式】
      <think>進化の思考プロセス</think>
      <evolved>進化後の質問文</evolved>
    prompts:
      - |
        以下の「比較・対照」視点の質問を進化させてください。
        
        【元の質問】
        {Question3}
        
        【主題】
        {QuestionTopic}
        
        多角的分析と違いの明確化を求める形式に発展させ、人間らしい表現に変換してください。
    outputs:
      - name: EvolvedQuestion3
        select: tag
        tag: evolved
      - name: Evolve3Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question3: EvolvedQuestion3

  # --- 質問4の進化: 影響・結果の視点 → 将来予測と影響分析 ---
  - type: ai
    exec: 44
    id: evolve_question4
    name: "Step 4-4: Evolve Question 4 (Impact & Result - Future Prediction)"
    model: qwen3
    system_prompt: |
      あなたは「影響・結果」を予測する質問の専門家です。
      与えられた質問を、以下の方向性で進化させてください：
      
      【進化の方向性：将来予測と影響分析】
      1. 短期的・長期的な影響の両方を求める形式に変換
      2. 直接的な影響だけでなく、波及効果や副次的影響も検討
      3. プラス面とマイナス面の両方を分析するよう促す
      4. リスクと機会の観点から影響を評価する
      
      【人間らしさの付与】
      - 実際のビジネスや社会への影響を想定
      - 複数のステークホルダーへの影響を考慮
      - 自然な話し言葉的表現に調整
      
      【重要なルール】
      - 質問は資料なしで単独で成立すること
      - 複雑になっても回答可能な範囲に留めること
      
      【出力形式】
      <think>進化の思考プロセス</think>
      <evolved>進化後の質問文</evolved>
    prompts:
      - |
        以下の「影響・結果」視点の質問を進化させてください。
        
        【元の質問】
        {Question4}
        
        【主題】
        {QuestionTopic}
        
        将来予測と影響分析を求める形式に発展させ、人間らしい表現に変換してください。
    outputs:
      - name: EvolvedQuestion4
        select: tag
        tag: evolved
      - name: Evolve4Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question4: EvolvedQuestion4

  # ============================================================
  # ステップ5: 各質問の個別検証（使用可/不可の判定）
  # ============================================================

  # --- 質問1の検証 ---
  - type: ai
    exec: 51
    id: validate_question1
    name: "Step 5-1: Validate Question 1"
    model: qwen3
    system_prompt: |
      あなたはLLM評価用プロンプトの品質評価専門家です。
      与えられた質問が「使用可能」か「使用不可」かを判定してください。
      
      【評価基準】
      1. 独立性: 資料なしで質問が完結しているか
      2. 自然さ: 人間が実際に使用しそうな表現か
      3. 回答可能性: LLMが適切に回答できる形式か
      4. 評価適性: LLMの能力を適切に評価できるか
      5. 複雑性: 適度な難易度があり、単純すぎないか
      
      【判定ルール】
      - 5つの基準のうち4つ以上が○なら「使用可能」
      - 3つ以下なら「使用不可」
      
      【出力形式】
      <think>評価の思考プロセス</think>
      <evaluation>
      - 独立性: ○/△/×
      - 自然さ: ○/△/×
      - 回答可能性: ○/△/×
      - 評価適性: ○/△/×
      - 複雑性: ○/△/×
      </evaluation>
      <valid>true または false</valid>
      <reason>判定理由</reason>
    prompts:
      - |
        以下の質問が「使用可能」か「使用不可」かを判定してください。
        
        【進化後の質問】
        {EvolvedQuestion1}
        
        【主題】
        {QuestionTopic}
        
        評価基準に従って評価し、使用可否を判定してください。
    outputs:
      - name: Evaluation1
        select: tag
        tag: evaluation
      - name: IsValid1
        select: tag
        tag: valid
      - name: Reason1
        select: tag
        tag: reason
      - name: Validate1Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid1: IsValid1

  # --- 質問2の検証 ---
  - type: ai
    exec: 52
    id: validate_question2
    name: "Step 5-2: Validate Question 2"
    model: qwen3
    system_prompt: |
      あなたはLLM評価用プロンプトの品質評価専門家です。
      与えられた質問が「使用可能」か「使用不可」かを判定してください。
      
      【評価基準】
      1. 独立性: 資料なしで質問が完結しているか
      2. 自然さ: 人間が実際に使用しそうな表現か
      3. 回答可能性: LLMが適切に回答できる形式か
      4. 評価適性: LLMの能力を適切に評価できるか
      5. 複雑性: 適度な難易度があり、単純すぎないか
      
      【判定ルール】
      - 5つの基準のうち4つ以上が○なら「使用可能」
      - 3つ以下なら「使用不可」
      
      【出力形式】
      <think>評価の思考プロセス</think>
      <evaluation>
      - 独立性: ○/△/×
      - 自然さ: ○/△/×
      - 回答可能性: ○/△/×
      - 評価適性: ○/△/×
      - 複雑性: ○/△/×
      </evaluation>
      <valid>true または false</valid>
      <reason>判定理由</reason>
    prompts:
      - |
        以下の質問が「使用可能」か「使用不可」かを判定してください。
        
        【進化後の質問】
        {EvolvedQuestion2}
        
        【主題】
        {QuestionTopic}
        
        評価基準に従って評価し、使用可否を判定してください。
    outputs:
      - name: Evaluation2
        select: tag
        tag: evaluation
      - name: IsValid2
        select: tag
        tag: valid
      - name: Reason2
        select: tag
        tag: reason
      - name: Validate2Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid2: IsValid2

  # --- 質問3の検証 ---
  - type: ai
    exec: 53
    id: validate_question3
    name: "Step 5-3: Validate Question 3"
    model: qwen3
    system_prompt: |
      あなたはLLM評価用プロンプトの品質評価専門家です。
      与えられた質問が「使用可能」か「使用不可」かを判定してください。
      
      【評価基準】
      1. 独立性: 資料なしで質問が完結しているか
      2. 自然さ: 人間が実際に使用しそうな表現か
      3. 回答可能性: LLMが適切に回答できる形式か
      4. 評価適性: LLMの能力を適切に評価できるか
      5. 複雑性: 適度な難易度があり、単純すぎないか
      
      【判定ルール】
      - 5つの基準のうち4つ以上が○なら「使用可能」
      - 3つ以下なら「使用不可」
      
      【出力形式】
      <think>評価の思考プロセス</think>
      <evaluation>
      - 独立性: ○/△/×
      - 自然さ: ○/△/×
      - 回答可能性: ○/△/×
      - 評価適性: ○/△/×
      - 複雑性: ○/△/×
      </evaluation>
      <valid>true または false</valid>
      <reason>判定理由</reason>
    prompts:
      - |
        以下の質問が「使用可能」か「使用不可」かを判定してください。
        
        【進化後の質問】
        {EvolvedQuestion3}
        
        【主題】
        {QuestionTopic}
        
        評価基準に従って評価し、使用可否を判定してください。
    outputs:
      - name: Evaluation3
        select: tag
        tag: evaluation
      - name: IsValid3
        select: tag
        tag: valid
      - name: Reason3
        select: tag
        tag: reason
      - name: Validate3Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid3: IsValid3

  # --- 質問4の検証 ---
  - type: ai
    exec: 54
    id: validate_question4
    name: "Step 5-4: Validate Question 4"
    model: qwen3
    system_prompt: |
      あなたはLLM評価用プロンプトの品質評価専門家です。
      与えられた質問が「使用可能」か「使用不可」かを判定してください。
      
      【評価基準】
      1. 独立性: 資料なしで質問が完結しているか
      2. 自然さ: 人間が実際に使用しそうな表現か
      3. 回答可能性: LLMが適切に回答できる形式か
      4. 評価適性: LLMの能力を適切に評価できるか
      5. 複雑性: 適度な難易度があり、単純すぎないか
      
      【判定ルール】
      - 5つの基準のうち4つ以上が○なら「使用可能」
      - 3つ以下なら「使用不可」
      
      【出力形式】
      <think>評価の思考プロセス</think>
      <evaluation>
      - 独立性: ○/△/×
      - 自然さ: ○/△/×
      - 回答可能性: ○/△/×
      - 評価適性: ○/△/×
      - 複雑性: ○/△/×
      </evaluation>
      <valid>true または false</valid>
      <reason>判定理由</reason>
    prompts:
      - |
        以下の質問が「使用可能」か「使用不可」かを判定してください。
        
        【進化後の質問】
        {EvolvedQuestion4}
        
        【主題】
        {QuestionTopic}
        
        評価基準に従って評価し、使用可否を判定してください。
    outputs:
      - name: Evaluation4
        select: tag
        tag: evaluation
      - name: IsValid4
        select: tag
        tag: valid
      - name: Reason4
        select: tag
        tag: reason
      - name: Validate4Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid4: IsValid4

  # ============================================================
  # ステップ6: 結果の整形とJSONL出力準備
  # ============================================================

  # 結果の詳細整形（人間可読形式）
  - type: python
    exec: 60
    id: format_detailed_result
    name: "Step 6a: Format Detailed Result"
    function: format_question_generator_v2
    code_path: ./examples/helpers.py
    inputs:
      source_text: "{text}"
      original_question: "{OriginalQuestion}"
      diversified_questions: "{DiversifiedQuestions}"
      evolved_question1: "{EvolvedQuestion1}"
      evolved_question2: "{EvolvedQuestion2}"
      evolved_question3: "{EvolvedQuestion3}"
      evolved_question4: "{EvolvedQuestion4}"
      is_valid1: "{IsValid1}"
      is_valid2: "{IsValid2}"
      is_valid3: "{IsValid3}"
      is_valid4: "{IsValid4}"
      evaluation1: "{Evaluation1}"
      evaluation2: "{Evaluation2}"
      evaluation3: "{Evaluation3}"
      evaluation4: "{Evaluation4}"
      step1_thinking: "{Step1Thinking}"
      step2_thinking: "{Step2Thinking}"
    outputs: [FormattedResult]
    use_env: "global"
    ctx_access: ["vars.read", "log"]

  # JSONL出力形式への整形
  - type: python
    exec: 61
    id: format_jsonl_output
    name: "Step 6b: Format JSONL Output"
    function: format_question_output_jsonl_v2
    code_path: ./examples/helpers.py
    inputs:
      source_text: "{text}"
      original_question: "{OriginalQuestion}"
      diversified_questions: "{DiversifiedQuestions}"
      evolved_question1: "{EvolvedQuestion1}"
      evolved_question2: "{EvolvedQuestion2}"
      evolved_question3: "{EvolvedQuestion3}"
      evolved_question4: "{EvolvedQuestion4}"
      is_valid1: "{IsValid1}"
      is_valid2: "{IsValid2}"
      is_valid3: "{IsValid3}"
      is_valid4: "{IsValid4}"
      evaluation1: "{Evaluation1}"
      evaluation2: "{Evaluation2}"
      evaluation3: "{Evaluation3}"
      evaluation4: "{Evaluation4}"
    outputs: [OutputData, ValidQuestions, ValidCount]
    use_env: "global"
    ctx_access: ["vars.read", "log"]

  # ============================================================
  # 終了ブロック
  # ============================================================
  - type: end
    exec: 100
    reason: "question_generation_v2_completed"
    exit_code: "success"
    final:
      # 主要な出力
      - name: valid_questions
        value: "{ValidQuestions}"
      - name: valid_count
        value: "{ValidCount}"
      - name: original_question
        value: "{OriginalQuestion}"
      - name: topic
        value: "{QuestionTopic}"
      # 4つの進化した質問と評価結果
      - name: evolved_question1
        value: "{EvolvedQuestion1}"
      - name: evolved_question2
        value: "{EvolvedQuestion2}"
      - name: evolved_question3
        value: "{EvolvedQuestion3}"
      - name: evolved_question4
        value: "{EvolvedQuestion4}"
      - name: is_valid1
        value: "{IsValid1}"
      - name: is_valid2
        value: "{IsValid2}"
      - name: is_valid3
        value: "{IsValid3}"
      - name: is_valid4
        value: "{IsValid4}"
      # 詳細データ
      - name: diversified_questions
        value: "{DiversifiedQuestions}"
      # 人間可読形式の結果
      - name: formatted_result
        value: "{FormattedResult}"
      # 構造化データ
      - name: output_data
        value: "{OutputData}"
    final_mode: "map"
    include_vars:
      - original_question
      - evolved_question1
      - evolved_question2
      - evolved_question3
      - evolved_question4
      - is_valid1
      - is_valid2
      - is_valid3
      - is_valid4

# 実行コマンド例:
# python -m sdg run \
#   --yaml examples/question_generator_agent_v2.yaml \
#   --input examples/data/question_generator_input.jsonl \
#   --output output/generated_questions_v2.jsonl \
#   --save-intermediate