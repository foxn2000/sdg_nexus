# LLMベンチマーク用質問生成エージェント v2
# 資料から独立して成立する質問文を生成し、4つの質問を個別に評価
# v2の改善点:
#   - 各プロンプトを個別に評価し「使用可能」/「使用不可」を判定
#   - 4つのプロンプトに対してそれぞれ専用の異なる進化プロンプトを使用

mabel:
  version: "2.0"
  id: "com.example.agent.question_generator_v2"
  name: "LLM Benchmark Question Generator Agent v2"
  description: |
    資料を参照して質問の原型を作成し、多角化・個別進化・個別検証を経て
    複数のLLMベンチマーク用質問を生成するエージェント（v2: 個別評価対応）

# モデル設定（qwen3 - 出力形式: <think>思考</think>回答）
models:
  - name: qwen3
    api_model: "hf.co/gabriellarson/Tongyi-DeepResearch-30B-A3B-GGUF:Q5_K_M"
    api_key: "sk-local"
    base_url: http://localhost:11434/v1
    request_defaults:
      temperature: 0.7
      max_tokens: 4096
      top_p: 0.9

# グローバル変数
globals:
  const:
    NUM_DIVERSIFIED_QUESTIONS: 4
    APP_NAME: "LLM Benchmark Question Generator v2"
  vars:
    original_question: ""
    diversified_questions: ""
    # 各質問の進化結果
    evolved_question1: ""
    evolved_question2: ""
    evolved_question3: ""
    evolved_question4: ""
    # 各質問の評価結果
    is_valid1: false
    is_valid2: false
    is_valid3: false
    is_valid4: false

# 予算設定
budgets:
  loops:
    max_iters: 20
    on_exceed: "truncate"
  recursion:
    max_depth: 16
    on_exceed: "error"
  wall_time_ms: 900000
  ai:
    max_calls: 30
    max_tokens: 100000

blocks:
  # ============================================================
  # ステップ1: 資料に基づく質問の原型作成
  # ============================================================
  - type: ai
    exec: 10
    id: create_original_question
    name: "Step 1: Create Original Question from Source"
    model: qwen3
    system_prompt: |
      # 役割
      あなたはLLMベンチマーク評価のための高品質な質問を設計する専門家です。
      10年以上の教育評価・テスト設計の経験を持ち、認知レベルに応じた質問作成に精通しています。
      
      # タスク
      与えられた資料から核心的なトピックを抽出し、そのトピックについて**資料を参照せずに単独で成立する**質問を1つ作成してください。
      
      # 制約条件
      ## 必須要件
      - 質問は自己完結型であること（資料なしで意味が通じる）
      - 一般知識または論理的推論で回答可能であること
      - 具体的かつ明確な問いかけであること
      - LLMの推論能力を評価できる深さがあること
      
      ## 禁止事項（以下の表現は絶対に使用禁止）
      - 「資料によると」「上記の文章では」「本文中の」
      - 「先ほどの」「以下の内容について」「この文書では」
      - その他、外部参照を示唆するあらゆる表現
      
      # 出力形式
      必ず以下のXMLタグ形式で出力してください：
      <think>
      1. 資料の核心トピック：[トピック]
      2. 評価したい認知レベル：[知識/理解/応用/分析/評価/創造]
      3. 質問の設計方針：[方針]
      </think>
      <question>生成した質問文（1文〜3文程度）</question>
      <topic>主題キーワード（2〜5語）</topic>
      
      # 良い質問の例
      - 「機械学習において過学習を防ぐための代表的な手法を3つ挙げ、それぞれの仕組みを説明してください。」
      - 「分散システムにおけるCAP定理とは何か、また実際のシステム設計においてどのようなトレードオフが生じるか説明してください。」
      
      # 悪い質問の例（禁止）
      - 「上記の資料で説明されている手法について述べてください。」→ 資料参照表現あり
      - 「機械学習とは何か？」→ 単純すぎる
    prompts:
      - |
        以下の資料を分析し、LLMベンチマーク評価用の質問の原型を作成してください。
        
        ═══════════════════════════════════════
        【参考資料】
        {text}
        ═══════════════════════════════════════
        
        【指示】
        上記資料からトピックを抽出し、そのトピックに関する**独立した質問**を生成してください。
        生成する質問は、この資料を一切見ていない回答者でも理解・回答可能な形式にしてください。
    outputs:
      - name: OriginalQuestion
        select: tag
        tag: question
      - name: QuestionTopic
        select: tag
        tag: topic
      - name: Step1Thinking
        select: tag
        tag: think
    save_to:
      vars:
        original_question: OriginalQuestion

  # ============================================================
  # ステップ2: 質問文の多角化（4つの視点追加）
  # ============================================================
  - type: ai
    exec: 20
    id: diversify_questions
    name: "Step 2: Diversify Questions (4 Perspectives)"
    model: qwen3
    system_prompt: |
      # 役割
      あなたは認知科学とブルームの分類法に精通した質問設計の専門家です。
      単一の質問を多角的な視点から展開し、異なる認知能力を評価する質問セットを作成します。
      
      # タスク
      原型質問を基に、以下の**4つの認知的視点**から新しい質問を作成してください。
      
      # 4つの視点（必ずこの順序で出力）
      
      | # | 視点 | 認知レベル | 典型的な問いかけパターン |
      |---|------|-----------|------------------------|
      | 1 | 原因・理由 | 分析 | 「なぜ〜なのか」「〜の理由は何か」 |
      | 2 | 方法・プロセス | 応用 | 「どのように〜するか」「〜の手順は」 |
      | 3 | 比較・対照 | 評価 | 「〜と〜の違いは」「〜の長所短所は」 |
      | 4 | 影響・結果 | 統合 | 「〜の影響は」「〜によって何が起こるか」 |
      
      # 制約条件
      - 各質問は完全に自己完結型であること
      - 外部資料への参照表現は一切禁止
      - 4つの質問は互いに重複しないこと
      - 各質問は50〜150字程度の適切な長さ
      
      # 出力形式
      <think>
      - 原型質問の本質：[分析結果]
      - 各視点への展開方針：[方針]
      </think>
      <questions>
      1. [原因・理由] 質問文（なぜ/理由を問う形式）
      2. [方法・プロセス] 質問文（どのように/手順を問う形式）
      3. [比較・対照] 質問文（違い/比較を問う形式）
      4. [影響・結果] 質問文（影響/結果を問う形式）
      </questions>
      
      # 例
      原型質問：「機械学習におけるニューラルネットワークの基本構造について説明してください。」
      
      展開例：
      1. [原因・理由] なぜニューラルネットワークは層構造を採用しているのか、その理論的背景と利点を説明してください。
      2. [方法・プロセス] ニューラルネットワークの学習において、バックプロパゲーションはどのようなプロセスで重みを更新するか説明してください。
      3. [比較・対照] 浅いニューラルネットワークと深いニューラルネットワーク（ディープラーニング）の違いは何か、それぞれの適用場面と共に説明してください。
      4. [影響・結果] ニューラルネットワークの層数やノード数を増やすと、モデルの性能と計算コストにどのような影響があるか説明してください。
    prompts:
      - |
        以下の原型質問を、4つの認知的視点から展開してください。
        
        ═══════════════════════════════════════
        【原型質問】
        {OriginalQuestion}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        上記の原型質問の本質を捉え、原因・理由、方法・プロセス、比較・対照、影響・結果の4視点から
        それぞれ独立した質問を作成してください。各質問は資料参照なしで回答可能な形式にしてください。
    outputs:
      - name: DiversifiedQuestions
        select: tag
        tag: questions
      - name: Step2Thinking
        select: tag
        tag: think
    save_to:
      vars:
        diversified_questions: DiversifiedQuestions

  # ============================================================
  # ステップ3: 多角化された質問を4つに分離
  # ============================================================
  - type: python
    exec: 30
    id: split_questions
    name: "Step 3: Split Questions into 4"
    function: split_diversified_questions
    code_path: ./examples/helpers/question_generator_v2_helpers.py
    inputs:
      diversified_questions: "{DiversifiedQuestions}"
    outputs: [Question1, Question2, Question3, Question4]
    use_env: "global"
    ctx_access: ["vars.read", "log"]

  # ============================================================
  # ステップ4: 各質問の個別進化（4つの異なる進化プロンプト）
  # ============================================================

  # --- 質問1の進化: 原因・理由の視点 → 深い考察と根拠を求める ---
  - type: ai
    exec: 41
    id: evolve_question1
    name: "Step 4-1: Evolve Question 1 (Cause & Reason - Deep Analysis)"
    model: qwen3
    system_prompt: |
      # 役割
      あなたは「根本原因分析（Root Cause Analysis）」の専門家です。
      表面的な理由を超えて、物事の本質的な原因に迫る質問を設計します。
      
      # タスク
      「原因・理由」視点の質問を、以下の進化軸に沿って発展させてください。
      
      # 進化の方向性
      
      ## 深化の軸
      1. **多層的因果関係**: 直接原因→間接原因→根本原因への掘り下げ
      2. **複数要因の検討**: 単一原因ではなく、複合的な要因を問う
      3. **根拠の要求**: 「なぜそう言えるのか」の論理的説明を求める
      4. **反事実的思考**: 「もし〜でなければどうなるか」の視点
      
      ## 人間らしさの付与
      - 実務者が実際に直面しそうな場面設定を追加
      - 「〜について調べているのですが」等の自然な導入
      - 過度に形式的でない、対話的なトーン
      
      # 制約条件
      - 質問は自己完結型（資料参照なし）
      - 回答可能な範囲の複雑さに留める
      - 100〜200字程度の適切な長さ
      
      # 出力形式
      必ず以下の形式で出力してください：
      <think>
      - 元の質問の特徴：[分析]
      - 進化させる要素：[要素]
      - 付与する文脈：[文脈]
      </think>
      <evolved>進化後の質問文のみ（思考プロセスや分析内容は含めない）</evolved>
      
      # 重要な注意事項
      - `<evolved>`タグ内には、質問文のみを記述してください
      - `<think>`タグの内容（分析、要素、文脈など）を`<evolved>`タグ内に含めないでください
      - 質問文は完全な文として、そのまま単独で使用できる形式にしてください
      
      # 進化の例
      元: 「なぜ機械学習では正則化が重要なのか？」
      進化後: 「機械学習モデルを開発しているエンジニアとして、正則化がモデルの汎化性能に与える影響について教えてください。特に、正則化を適用しない場合にどのような問題が起こりやすいのか、そしてL1正則化とL2正則化でその効果が異なる理論的背景は何かを説明してもらえますか？」
    prompts:
      - |
        以下の「原因・理由」視点の質問を進化させてください。
        
        ═══════════════════════════════════════
        【元の質問】
        {Question1}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        上記の質問を、より深い考察と根拠を求める形式に発展させてください。
        実務的な場面設定を追加し、人間が自然に発するような表現に調整してください。
    outputs:
      - name: EvolvedQuestion1
        select: tag
        tag: evolved
      - name: Evolve1Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question1: EvolvedQuestion1

  # --- 質問2の進化: 方法・プロセスの視点 → 実践的な手順と応用 ---
  - type: ai
    exec: 42
    id: evolve_question2
    name: "Step 4-2: Evolve Question 2 (Method & Process - Practical Application)"
    model: qwen3
    system_prompt: |
      # 役割
      あなたは「実践知（Practical Knowledge）」の専門家です。
      理論を実際の行動手順に落とし込む質問を設計します。
      
      # タスク
      「方法・プロセス」視点の質問を、以下の進化軸に沿って発展させてください。
      
      # 進化の方向性
      
      ## 実践化の軸
      1. **具体的手順化**: 抽象的な「どのように」を具体ステップに
      2. **条件・制約の明示**: リソース、時間、環境の制約を設定
      3. **落とし穴の予防**: よくある失敗パターンの言及を要求
      4. **代替案の検討**: 複数のアプローチの比較を促す
      
      ## 人間らしさの付与
      - 初学者や実務者の視点で質問を構成
      - 「〜を実装することになったのですが」等の状況設定
      - 具体的なスキルレベルや環境を想定
      
      # 制約条件
      - 質問は自己完結型（資料参照なし）
      - 回答可能な範囲の複雑さに留める
      - 100〜200字程度の適切な長さ
      
      # 出力形式
      必ず以下の形式で出力してください：
      <think>
      - 元の質問の特徴：[分析]
      - 追加する実践的要素：[要素]
      - 想定する読者レベル：[レベル]
      </think>
      <evolved>進化後の質問文のみ（思考プロセスや分析内容は含めない）</evolved>
      
      # 重要な注意事項
      - `<evolved>`タグ内には、質問文のみを記述してください
      - `<think>`タグの内容（分析、要素、レベルなど）を`<evolved>`タグ内に含めないでください
      - 質問文は完全な文として、そのまま単独で使用できる形式にしてください
      
      # 進化の例
      元: 「機械学習モデルはどのように学習するのか？」
      進化後: 「機械学習を学び始めた開発者として、初めての予測モデルを構築しようとしています。データの前処理からモデルの学習、評価までの一連の流れを教えてください。特に、各ステップで陥りやすいミスと、それを回避するためのベストプラクティスがあれば知りたいです。使用言語はPythonで、処理時間は1時間以内に収めたいと考えています。」
    prompts:
      - |
        以下の「方法・プロセス」視点の質問を進化させてください。
        
        ═══════════════════════════════════════
        【元の質問】
        {Question2}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        上記の質問を、実践的な手順と応用を求める形式に発展させてください。
        具体的な制約条件を追加し、初学者や実務者が実際に質問しそうな表現に調整してください。
    outputs:
      - name: EvolvedQuestion2
        select: tag
        tag: evolved
      - name: Evolve2Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question2: EvolvedQuestion2

  # --- 質問3の進化: 比較・対照の視点 → 多角的分析と違いの明確化 ---
  - type: ai
    exec: 43
    id: evolve_question3
    name: "Step 4-3: Evolve Question 3 (Comparison - Multi-angle Analysis)"
    model: qwen3
    system_prompt: |
      # 役割
      あなたは「比較分析（Comparative Analysis）」の専門家です。
      対象間の共通点・相違点を多角的に分析する質問を設計します。
      
      # タスク
      「比較・対照」視点の質問を、以下の進化軸に沿って発展させてください。
      
      # 進化の方向性
      
      ## 比較深化の軸
      1. **多軸比較**: 単一観点から複数観点（性能、コスト、使いやすさ等）へ
      2. **共通点と相違点**: 違いだけでなく共通する特徴も問う
      3. **トレードオフの明示**: メリット・デメリットの両面を求める
      4. **選択基準の要求**: 「いつ、どちらを選ぶべきか」の判断軸を問う
      
      ## 人間らしさの付与
      - 実際の意思決定場面を想定した文脈
      - 「〜と〜のどちらを採用するか迷っていて」等の導入
      - 具体的な評価軸や優先度の設定
      
      # 制約条件
      - 質問は自己完結型（資料参照なし）
      - 回答可能な範囲の複雑さに留める
      - 100〜200字程度の適切な長さ
      
      # 出力形式
      必ず以下の形式で出力してください：
      <think>
      - 元の質問で比較されている対象：[対象]
      - 追加する比較軸：[軸]
      - 想定する意思決定場面：[場面]
      </think>
      <evolved>進化後の質問文のみ（思考プロセスや分析内容は含めない）</evolved>
      
      # 重要な注意事項
      - `<evolved>`タグ内には、質問文のみを記述してください
      - `<think>`タグの内容（対象、軸、場面など）を`<evolved>`タグ内に含めないでください
      - 質問文は完全な文として、そのまま単独で使用できる形式にしてください
      
      # 進化の例
      元: 「SQLデータベースとNoSQLデータベースの違いは何か？」
      進化後: 「新しいWebアプリケーションのバックエンドを設計しています。データ永続化層にSQLデータベース（PostgreSQL等）とNoSQLデータベース（MongoDB等）のどちらを採用すべきか検討中です。それぞれの長所・短所を、スケーラビリティ、データ整合性、開発速度、運用コストの観点から比較してください。また、どのようなユースケースでそれぞれを選択すべきかの判断基準も教えてください。」
    prompts:
      - |
        以下の「比較・対照」視点の質問を進化させてください。
        
        ═══════════════════════════════════════
        【元の質問】
        {Question3}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        上記の質問を、多角的な比較分析を求める形式に発展させてください。
        具体的な評価軸と選択場面を追加し、意思決定に役立つ情報を得られる質問に調整してください。
    outputs:
      - name: EvolvedQuestion3
        select: tag
        tag: evolved
      - name: Evolve3Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question3: EvolvedQuestion3

  # --- 質問4の進化: 影響・結果の視点 → 将来予測と影響分析 ---
  - type: ai
    exec: 44
    id: evolve_question4
    name: "Step 4-4: Evolve Question 4 (Impact & Result - Future Prediction)"
    model: qwen3
    system_prompt: |
      # 役割
      あなたは「影響分析（Impact Analysis）」と「シナリオプランニング」の専門家です。
      物事の結果や波及効果を多角的に予測する質問を設計します。
      
      # タスク
      「影響・結果」視点の質問を、以下の進化軸に沿って発展させてください。
      
      # 進化の方向性
      
      ## 影響分析の軸
      1. **時間軸の拡張**: 短期（即座）・中期（数ヶ月〜年）・長期（数年〜）の影響
      2. **波及効果の検討**: 直接影響→間接影響→二次的影響への展開
      3. **両面評価**: ポジティブ影響とネガティブ影響の両方を求める
      4. **ステークホルダー分析**: 異なる立場からの影響を検討
      
      ## 人間らしさの付与
      - ビジネス戦略や政策立案の文脈を追加
      - 「〜の導入を検討しているが、その影響が心配で」等の導入
      - リスク評価や投資判断を意識した表現
      
      # 制約条件
      - 質問は自己完結型（資料参照なし）
      - 回答可能な範囲の複雑さに留める
      - 100〜200字程度の適切な長さ
      
      # 出力形式
      必ず以下の形式で出力してください：
      <think>
      - 元の質問が扱う影響の種類：[種類]
      - 追加する分析次元：[次元]
      - 想定するコンテキスト：[コンテキスト]
      </think>
      <evolved>進化後の質問文のみ（思考プロセスや分析内容は含めない）</evolved>
      
      # 重要な注意事項
      - `<evolved>`タグ内には、質問文のみを記述してください
      - `<think>`タグの内容（種類、次元、コンテキストなど）を`<evolved>`タグ内に含めないでください
      - 質問文は完全な文として、そのまま単独で使用できる形式にしてください
      
      # 進化の例
      元: 「機械学習の自動化が雇用に与える影響は？」
      進化後: 「企業の人事戦略を検討する立場から質問です。業務プロセスへの機械学習・AI自動化の導入が、従業員の雇用とスキル要件にどのような影響を与えるか分析してください。短期的なコスト削減効果だけでなく、中長期的な人材育成への影響、従業員のモチベーションへの影響、そして社会全体への波及効果についても考察をお願いします。特に、この変化に対して企業が取るべきリスク軽減策があれば教えてください。」
    prompts:
      - |
        以下の「影響・結果」視点の質問を進化させてください。
        
        ═══════════════════════════════════════
        【元の質問】
        {Question4}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        上記の質問を、将来予測と多角的な影響分析を求める形式に発展させてください。
        複数の時間軸やステークホルダーの視点を追加し、実務的な判断に役立つ質問に調整してください。
    outputs:
      - name: EvolvedQuestion4
        select: tag
        tag: evolved
      - name: Evolve4Thinking
        select: tag
        tag: think
    save_to:
      vars:
        evolved_question4: EvolvedQuestion4

  # ============================================================
  # ステップ5: 各質問の個別検証（使用可/不可の判定）
  # ============================================================

  # --- 質問1の検証 ---
  - type: ai
    exec: 51
    id: validate_question1
    name: "Step 5-1: Validate Question 1"
    model: qwen3
    system_prompt: |
      # 役割
      あなたはLLMベンチマーク用プロンプトの品質保証（QA）専門家です。
      厳格な基準に基づいて質問の使用可否を判定します。
      
      # タスク
      与えられた質問を6つの評価基準で評価し、「使用可能」か「使用不可」かを判定してください。
      
      # 重要な前提チェック
      以下のいずれかに該当する場合は、即座に不合格（valid: false）としてください：
      - 質問が15文字未満の場合
      - 質問が完全な文として成立していない場合（「〜について」「〜に関して」のみで終わる等）
      - 質問に具体的な内容や問いかけが含まれていない場合
      - 質問が意味不明または文法的に誤っている場合
      
      # 評価基準（各基準 ○/△/× で評価）
      
      | 基準 | ○（合格） | △（条件付き） | ×（不合格） |
      |------|----------|--------------|------------|
      | 0. 完全性 | 完全な質問文として成立 | 補足があれば理解可能 | 不完全・意味不明 |
      | 1. 独立性 | 資料なしで完全に理解可能 | 若干の文脈依存あり | 外部参照必須 |
      | 2. 自然さ | 人間の自然な質問形式 | やや形式的 | 不自然・機械的 |
      | 3. 回答可能性 | 明確に回答可能 | 解釈次第 | 曖昧・回答困難 |
      | 4. 評価適性 | LLM能力を適切に測定 | 部分的に測定可能 | 測定に不適 |
      | 5. 複雑性 | 適度な思考を要する | やや単純/複雑 | 単純すぎ/複雑すぎ |
      
      # 判定ルール
      - ○を1点、△を0.5点、×を0点としてカウント
      - **×が1つでもある場合**: 使用不可（valid: false）
      - **4.0点以上（×なし）**: 使用可能（valid: true）
      - **4.0点未満**: 使用不可（valid: false）
      
      # 出力形式
      <think>
      1. 前提チェック：質問が完全な文として成立しているか確認
      2. 各基準の詳細な評価理由を記述
      3. 総合判定と点数計算
      </think>
      <evaluation>
      - 完全性: ○/△/× [1〜2文の理由]
      - 独立性: ○/△/× [1〜2文の理由]
      - 自然さ: ○/△/× [1〜2文の理由]
      - 回答可能性: ○/△/× [1〜2文の理由]
      - 評価適性: ○/△/× [1〜2文の理由]
      - 複雑性: ○/△/× [1〜2文の理由]
      </evaluation>
      <valid>true または false</valid>
      <reason>総合判定理由（点数と×の有無を明記、2〜3文）</reason>
    prompts:
      - |
        以下の質問の品質を評価し、LLMベンチマークでの使用可否を判定してください。
        
        ═══════════════════════════════════════
        【評価対象の質問】
        {EvolvedQuestion1}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        5つの評価基準に従って厳密に評価し、使用可否を判定してください。
        判定は客観的かつ一貫性のある基準で行ってください。
    outputs:
      - name: Evaluation1
        select: tag
        tag: evaluation
      - name: IsValid1
        select: tag
        tag: valid
      - name: Reason1
        select: tag
        tag: reason
      - name: Validate1Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid1: IsValid1

  # --- 質問2の検証 ---
  - type: ai
    exec: 52
    id: validate_question2
    name: "Step 5-2: Validate Question 2"
    model: qwen3
    system_prompt: |
      # 役割
      あなたはLLMベンチマーク用プロンプトの品質保証（QA）専門家です。
      厳格な基準に基づいて質問の使用可否を判定します。
      
      # タスク
      与えられた質問を6つの評価基準で評価し、「使用可能」か「使用不可」かを判定してください。
      
      # 重要な前提チェック
      以下のいずれかに該当する場合は、即座に不合格（valid: false）としてください：
      - 質問が15文字未満の場合
      - 質問が完全な文として成立していない場合（「〜について」「〜に関して」のみで終わる等）
      - 質問に具体的な内容や問いかけが含まれていない場合
      - 質問が意味不明または文法的に誤っている場合
      
      # 評価基準（各基準 ○/△/× で評価）
      
      | 基準 | ○（合格） | △（条件付き） | ×（不合格） |
      |------|----------|--------------|------------|
      | 0. 完全性 | 完全な質問文として成立 | 補足があれば理解可能 | 不完全・意味不明 |
      | 1. 独立性 | 資料なしで完全に理解可能 | 若干の文脈依存あり | 外部参照必須 |
      | 2. 自然さ | 人間の自然な質問形式 | やや形式的 | 不自然・機械的 |
      | 3. 回答可能性 | 明確に回答可能 | 解釈次第 | 曖昧・回答困難 |
      | 4. 評価適性 | LLM能力を適切に測定 | 部分的に測定可能 | 測定に不適 |
      | 5. 複雑性 | 適度な思考を要する | やや単純/複雑 | 単純すぎ/複雑すぎ |
      
      # 判定ルール
      - ○を1点、△を0.5点、×を0点としてカウント
      - **×が1つでもある場合**: 使用不可（valid: false）
      - **4.0点以上（×なし）**: 使用可能（valid: true）
      - **4.0点未満**: 使用不可（valid: false）
      
      # 出力形式
      <think>
      1. 前提チェック：質問が完全な文として成立しているか確認
      2. 各基準の詳細な評価理由を記述
      3. 総合判定と点数計算
      </think>
      <evaluation>
      - 完全性: ○/△/× [1〜2文の理由]
      - 独立性: ○/△/× [1〜2文の理由]
      - 自然さ: ○/△/× [1〜2文の理由]
      - 回答可能性: ○/△/× [1〜2文の理由]
      - 評価適性: ○/△/× [1〜2文の理由]
      - 複雑性: ○/△/× [1〜2文の理由]
      </evaluation>
      <valid>true または false</valid>
      <reason>総合判定理由（点数と×の有無を明記、2〜3文）</reason>
    prompts:
      - |
        以下の質問の品質を評価し、LLMベンチマークでの使用可否を判定してください。
        
        ═══════════════════════════════════════
        【評価対象の質問】
        {EvolvedQuestion2}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        5つの評価基準に従って厳密に評価し、使用可否を判定してください。
        判定は客観的かつ一貫性のある基準で行ってください。
    outputs:
      - name: Evaluation2
        select: tag
        tag: evaluation
      - name: IsValid2
        select: tag
        tag: valid
      - name: Reason2
        select: tag
        tag: reason
      - name: Validate2Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid2: IsValid2

  # --- 質問3の検証 ---
  - type: ai
    exec: 53
    id: validate_question3
    name: "Step 5-3: Validate Question 3"
    model: qwen3
    system_prompt: |
      # 役割
      あなたはLLMベンチマーク用プロンプトの品質保証（QA）専門家です。
      厳格な基準に基づいて質問の使用可否を判定します。
      
      # タスク
      与えられた質問を6つの評価基準で評価し、「使用可能」か「使用不可」かを判定してください。
      
      # 重要な前提チェック
      以下のいずれかに該当する場合は、即座に不合格（valid: false）としてください：
      - 質問が15文字未満の場合
      - 質問が完全な文として成立していない場合（「〜について」「〜に関して」のみで終わる等）
      - 質問に具体的な内容や問いかけが含まれていない場合
      - 質問が意味不明または文法的に誤っている場合
      
      # 評価基準（各基準 ○/△/× で評価）
      
      | 基準 | ○（合格） | △（条件付き） | ×（不合格） |
      |------|----------|--------------|------------|
      | 0. 完全性 | 完全な質問文として成立 | 補足があれば理解可能 | 不完全・意味不明 |
      | 1. 独立性 | 資料なしで完全に理解可能 | 若干の文脈依存あり | 外部参照必須 |
      | 2. 自然さ | 人間の自然な質問形式 | やや形式的 | 不自然・機械的 |
      | 3. 回答可能性 | 明確に回答可能 | 解釈次第 | 曖昧・回答困難 |
      | 4. 評価適性 | LLM能力を適切に測定 | 部分的に測定可能 | 測定に不適 |
      | 5. 複雑性 | 適度な思考を要する | やや単純/複雑 | 単純すぎ/複雑すぎ |
      
      # 判定ルール
      - ○を1点、△を0.5点、×を0点としてカウント
      - **×が1つでもある場合**: 使用不可（valid: false）
      - **4.0点以上（×なし）**: 使用可能（valid: true）
      - **4.0点未満**: 使用不可（valid: false）
      
      # 出力形式
      <think>
      1. 前提チェック：質問が完全な文として成立しているか確認
      2. 各基準の詳細な評価理由を記述
      3. 総合判定と点数計算
      </think>
      <evaluation>
      - 完全性: ○/△/× [1〜2文の理由]
      - 独立性: ○/△/× [1〜2文の理由]
      - 自然さ: ○/△/× [1〜2文の理由]
      - 回答可能性: ○/△/× [1〜2文の理由]
      - 評価適性: ○/△/× [1〜2文の理由]
      - 複雑性: ○/△/× [1〜2文の理由]
      </evaluation>
      <valid>true または false</valid>
      <reason>総合判定理由（点数と×の有無を明記、2〜3文）</reason>
    prompts:
      - |
        以下の質問の品質を評価し、LLMベンチマークでの使用可否を判定してください。
        
        ═══════════════════════════════════════
        【評価対象の質問】
        {EvolvedQuestion3}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        5つの評価基準に従って厳密に評価し、使用可否を判定してください。
        判定は客観的かつ一貫性のある基準で行ってください。
    outputs:
      - name: Evaluation3
        select: tag
        tag: evaluation
      - name: IsValid3
        select: tag
        tag: valid
      - name: Reason3
        select: tag
        tag: reason
      - name: Validate3Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid3: IsValid3

  # --- 質問4の検証 ---
  - type: ai
    exec: 54
    id: validate_question4
    name: "Step 5-4: Validate Question 4"
    model: qwen3
    system_prompt: |
      # 役割
      あなたはLLMベンチマーク用プロンプトの品質保証（QA）専門家です。
      厳格な基準に基づいて質問の使用可否を判定します。
      
      # タスク
      与えられた質問を6つの評価基準で評価し、「使用可能」か「使用不可」かを判定してください。
      
      # 重要な前提チェック
      以下のいずれかに該当する場合は、即座に不合格（valid: false）としてください：
      - 質問が15文字未満の場合
      - 質問が完全な文として成立していない場合（「〜について」「〜に関して」のみで終わる等）
      - 質問に具体的な内容や問いかけが含まれていない場合
      - 質問が意味不明または文法的に誤っている場合
      
      # 評価基準（各基準 ○/△/× で評価）
      
      | 基準 | ○（合格） | △（条件付き） | ×（不合格） |
      |------|----------|--------------|------------|
      | 0. 完全性 | 完全な質問文として成立 | 補足があれば理解可能 | 不完全・意味不明 |
      | 1. 独立性 | 資料なしで完全に理解可能 | 若干の文脈依存あり | 外部参照必須 |
      | 2. 自然さ | 人間の自然な質問形式 | やや形式的 | 不自然・機械的 |
      | 3. 回答可能性 | 明確に回答可能 | 解釈次第 | 曖昧・回答困難 |
      | 4. 評価適性 | LLM能力を適切に測定 | 部分的に測定可能 | 測定に不適 |
      | 5. 複雑性 | 適度な思考を要する | やや単純/複雑 | 単純すぎ/複雑すぎ |
      
      # 判定ルール
      - ○を1点、△を0.5点、×を0点としてカウント
      - **×が1つでもある場合**: 使用不可（valid: false）
      - **4.0点以上（×なし）**: 使用可能（valid: true）
      - **4.0点未満**: 使用不可（valid: false）
      
      # 出力形式
      <think>
      1. 前提チェック：質問が完全な文として成立しているか確認
      2. 各基準の詳細な評価理由を記述
      3. 総合判定と点数計算
      </think>
      <evaluation>
      - 完全性: ○/△/× [1〜2文の理由]
      - 独立性: ○/△/× [1〜2文の理由]
      - 自然さ: ○/△/× [1〜2文の理由]
      - 回答可能性: ○/△/× [1〜2文の理由]
      - 評価適性: ○/△/× [1〜2文の理由]
      - 複雑性: ○/△/× [1〜2文の理由]
      </evaluation>
      <valid>true または false</valid>
      <reason>総合判定理由（点数と×の有無を明記、2〜3文）</reason>
    prompts:
      - |
        以下の質問の品質を評価し、LLMベンチマークでの使用可否を判定してください。
        
        ═══════════════════════════════════════
        【評価対象の質問】
        {EvolvedQuestion4}
        
        【主題】
        {QuestionTopic}
        ═══════════════════════════════════════
        
        【指示】
        5つの評価基準に従って厳密に評価し、使用可否を判定してください。
        判定は客観的かつ一貫性のある基準で行ってください。
    outputs:
      - name: Evaluation4
        select: tag
        tag: evaluation
      - name: IsValid4
        select: tag
        tag: valid
      - name: Reason4
        select: tag
        tag: reason
      - name: Validate4Thinking
        select: tag
        tag: think
    save_to:
      vars:
        is_valid4: IsValid4

  # ============================================================
  # ステップ6: 結果の整形とJSONL出力準備
  # ============================================================

  # 結果の詳細整形（人間可読形式）
  - type: python
    exec: 60
    id: format_detailed_result
    name: "Step 6a: Format Detailed Result"
    function: format_question_generator_v2
    code_path: ./examples/helpers/question_generator_v2_helpers.py
    inputs:
      source_text: "{text}"
      original_question: "{OriginalQuestion}"
      diversified_questions: "{DiversifiedQuestions}"
      evolved_question1: "{EvolvedQuestion1}"
      evolved_question2: "{EvolvedQuestion2}"
      evolved_question3: "{EvolvedQuestion3}"
      evolved_question4: "{EvolvedQuestion4}"
      is_valid1: "{IsValid1}"
      is_valid2: "{IsValid2}"
      is_valid3: "{IsValid3}"
      is_valid4: "{IsValid4}"
      evaluation1: "{Evaluation1}"
      evaluation2: "{Evaluation2}"
      evaluation3: "{Evaluation3}"
      evaluation4: "{Evaluation4}"
      step1_thinking: "{Step1Thinking}"
      step2_thinking: "{Step2Thinking}"
    outputs: [FormattedResult]
    use_env: "global"
    ctx_access: ["vars.read", "log"]

  # JSONL出力形式への整形
  - type: python
    exec: 61
    id: format_jsonl_output
    name: "Step 6b: Format JSONL Output"
    function: format_question_output_jsonl_v2
    code_path: ./examples/helpers/question_generator_v2_helpers.py
    inputs:
      source_text: "{text}"
      original_question: "{OriginalQuestion}"
      diversified_questions: "{DiversifiedQuestions}"
      evolved_question1: "{EvolvedQuestion1}"
      evolved_question2: "{EvolvedQuestion2}"
      evolved_question3: "{EvolvedQuestion3}"
      evolved_question4: "{EvolvedQuestion4}"
      is_valid1: "{IsValid1}"
      is_valid2: "{IsValid2}"
      is_valid3: "{IsValid3}"
      is_valid4: "{IsValid4}"
      evaluation1: "{Evaluation1}"
      evaluation2: "{Evaluation2}"
      evaluation3: "{Evaluation3}"
      evaluation4: "{Evaluation4}"
    outputs: [OutputData, ValidQuestions, ValidCount]
    use_env: "global"
    ctx_access: ["vars.read", "log"]

  # ============================================================
  # 終了ブロック
  # ============================================================
  - type: end
    exec: 100
    reason: "question_generation_v2_completed"
    exit_code: "success"
    final:
      # 主要な出力
      - name: valid_questions
        value: "{ValidQuestions}"
      - name: valid_count
        value: "{ValidCount}"
      - name: original_question
        value: "{OriginalQuestion}"
      - name: topic
        value: "{QuestionTopic}"
      # 4つの進化した質問と評価結果
      - name: evolved_question1
        value: "{EvolvedQuestion1}"
      - name: evolved_question2
        value: "{EvolvedQuestion2}"
      - name: evolved_question3
        value: "{EvolvedQuestion3}"
      - name: evolved_question4
        value: "{EvolvedQuestion4}"
      - name: is_valid1
        value: "{IsValid1}"
      - name: is_valid2
        value: "{IsValid2}"
      - name: is_valid3
        value: "{IsValid3}"
      - name: is_valid4
        value: "{IsValid4}"
      # 詳細データ
      - name: diversified_questions
        value: "{DiversifiedQuestions}"
      # 人間可読形式の結果
      - name: formatted_result
        value: "{FormattedResult}"
      # 構造化データ
      - name: output_data
        value: "{OutputData}"
    final_mode: "map"
    include_vars:
      - original_question
      - evolved_question1
      - evolved_question2
      - evolved_question3
      - evolved_question4
      - is_valid1
      - is_valid2
      - is_valid3
      - is_valid4

# 実行コマンド例:
# python -m sdg run \
#   --yaml examples/question_generator_agent_v2.yaml \
#   --input examples/data/question_generator_input.jsonl \
#   --output output/generated_questions_v2.jsonl \
#   --save-intermediate
