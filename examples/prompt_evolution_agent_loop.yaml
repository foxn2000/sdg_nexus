# プロンプト進化エージェント
# ユーザー入力から新しいプロンプトを生成し、難易度を上げ、妥当性をチェックして最終回答を取得
# 妥当性チェックに失敗した場合は、最大2回までプロンプト生成からやり直す

mabel:
  version: "2.0"
  id: "com.example.agent.prompt_evolution"
  name: "Prompt Evolution Agent"
  description: "入力から異なるプロンプトを生成し、難易度を上げ、妥当性チェック後に回答を取得するエージェント（リトライ機能付き）"

# モデル設定
models:
  - name: qwen3
    api_model: qwen3
    api_key: "sk-local"
    base_url: http://localhost:8000/v1
    request_defaults:
      temperature: 0.7
      max_tokens: 2048

# グローバル変数
globals:
  const:
    MAX_RETRY: 2
  vars:
    retry_count: 0
    is_valid: false
    is_valid_round1: false
    is_valid_round2: false
    current_prompt: ""
    enhanced_prompt: ""
    final_prompt: ""
    final_answer: ""
    all_generate_thinking: ""
    all_enhance_thinking: ""
    all_validate_thinking: ""

# 予算設定
budgets:
  loops:
    max_iters: 10
    on_exceed: "truncate"
  recursion:
    max_depth: 8
    on_exceed: "error"
  wall_time_ms: 300000

blocks:
  # ============================================================
  # 初期化
  # ============================================================
  - type: logic
    exec: 1
    id: init
    name: "Initialize Variables"
    op: set
    var: retry_count
    value: 0
    outputs:
      - name: RetryCount
        from: value

  # ============================================================
  # ラウンド1: プロンプト生成 → 難易度向上 → 妥当性チェック
  # ============================================================

  # ラウンド1: プロンプト生成
  - type: ai
    exec: 10
    id: generate_prompt_round1
    name: "Round 1: Generate New Prompt"
    model: qwen3
    system_prompt: |
      あなたは創造的なプロンプトエンジニアです。
      ユーザーから与えられた入力を分析し、それとは全く異なる主旨・内容の新しいプロンプトを生成してください。
      
      重要なルール：
      1. 元の入力のテーマや内容とは全く異なるものを作成すること
      2. 生成したプロンプトは必ず <prompt>...</prompt> タグで囲むこと
      3. プロンプトは具体的で、明確な指示を含むこと
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <prompt>生成したプロンプト内容</prompt>
    prompts:
      - |
        以下の入力から、全く異なる主旨・内容のプロンプトを新たに生成してください：
        
        入力: {input}
    outputs:
      - name: GeneratedPrompt
        select: tag
        tag: prompt
      - name: GenerateThinking
        select: tag
        tag: think
    save_to:
      vars:
        current_prompt: GeneratedPrompt
        all_generate_thinking: GenerateThinking

  # ラウンド1: 難易度向上
  - type: ai
    exec: 11
    id: enhance_prompt_round1
    name: "Round 1: Enhance Prompt Difficulty"
    model: qwen3
    system_prompt: |
      あなたは高度なプロンプトエンジニアです。
      与えられたプロンプトをより難易度の高いものに再加工してください。
      
      難易度向上の方法：
      1. より深い分析や考察を要求する
      2. 複数の視点からの検討を求める
      3. 制約条件や追加の要求を加える
      4. 専門的な知識や論理的思考を必要とする要素を追加
      
      重要：難易度を高めたプロンプトは必ず <prompt>...</prompt> タグで囲むこと
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <prompt>難易度を高めたプロンプト内容</prompt>
    prompts:
      - |
        以下のプロンプトの難易度を高めてください：
        
        元のプロンプト: {GeneratedPrompt}
    outputs:
      - name: EnhancedPrompt
        select: tag
        tag: prompt
      - name: EnhanceThinking
        select: tag
        tag: think
    save_to:
      vars:
        enhanced_prompt: EnhancedPrompt
        all_enhance_thinking: EnhanceThinking

  # ラウンド1: 妥当性チェック
  - type: ai
    exec: 12
    id: validate_prompt_round1
    name: "Round 1: Validate Prompt"
    model: qwen3
    system_prompt: |
      あなたはプロンプトの妥当性を評価する専門家です。
      与えられたプロンプトが実際に成立するかどうかを判定してください。
      
      判定基準：
      1. プロンプトが明確で理解可能か
      2. 要求されている内容が実現可能か
      3. 論理的な矛盾がないか
      4. 適切な回答が可能か
      
      判定結果：
      - 成立する場合: <valid>true</valid>
      - 成立しない場合: <valid>false</valid> と <reason>理由</reason>
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <valid>true または false</valid>
      <reason>成立しない場合の理由（成立する場合は空欄可）</reason>
    prompts:
      - |
        以下のプロンプトが実際に成立するかどうかを判定してください：
        
        プロンプト: {EnhancedPrompt}
    outputs:
      - name: IsValid
        select: tag
        tag: valid
      - name: InvalidReason
        select: tag
        tag: reason
      - name: ValidateThinking
        select: tag
        tag: think
    save_to:
      vars:
        all_validate_thinking: ValidateThinking

  # ラウンド1: 妥当性判定の処理
  - type: logic
    exec: 13
    id: check_validation_round1
    name: "Round 1: Check Validation Result"
    op: if
    cond:
      or:
        - equals: ["{IsValid}", "true"]
        - contains: ["{IsValid}", "true"]
    then: "valid"
    else: "invalid"
    outputs:
      - name: ValidationStatus_R1
        from: value
      - name: IsPromptValid_R1
        from: boolean

  # ラウンド1: リトライカウントをインクリメント
  - type: logic
    exec: 14
    id: increment_retry_round1
    name: "Round 1: Increment Retry Count"
    op: set
    var: retry_count
    value: 1
    outputs:
      - name: RetryCount_R1
        from: value

  # ============================================================
  # ラウンド2: 妥当性チェックに失敗した場合のみ実行
  # 注意: IsPromptValid_R1 は boolean の True/False で、
  #       文字列化すると "True"/"False" (大文字始まり) になる
  # ============================================================

  # ラウンド2: プロンプト生成（ラウンド1が無効な場合のみ）
  - type: ai
    exec: 20
    id: generate_prompt_round2
    name: "Round 2: Generate New Prompt (Retry)"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    model: qwen3
    system_prompt: |
      あなたは創造的なプロンプトエンジニアです。
      前回生成したプロンプトは妥当性チェックに失敗しました。
      今回は、より実現可能で明確なプロンプトを生成してください。
      
      重要なルール：
      1. 元の入力のテーマや内容とは全く異なるものを作成すること
      2. 生成したプロンプトは必ず <prompt>...</prompt> タグで囲むこと
      3. プロンプトは具体的で、明確な指示を含むこと
      4. 前回の失敗理由を考慮し、より実現可能なプロンプトにすること
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <prompt>生成したプロンプト内容</prompt>
    prompts:
      - |
        以下の入力から、全く異なる主旨・内容のプロンプトを新たに生成してください。
        （これは2回目の試行です。前回は妥当性チェックに失敗しました）
        
        入力: {input}
        前回の失敗理由: {InvalidReason}
    outputs:
      - name: GeneratedPrompt_R2
        select: tag
        tag: prompt
      - name: GenerateThinking_R2
        select: tag
        tag: think
    save_to:
      vars:
        current_prompt: GeneratedPrompt_R2

  # ラウンド2: 生成プロンプトの更新（ラウンド1が無効な場合のみ）
  - type: logic
    exec: 21
    id: update_generated_prompt_round2
    name: "Round 2: Update Generated Prompt"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    op: set
    var: all_generate_thinking
    value: {"concat": [{"var": "all_generate_thinking"}, "\n\n[Round 2]\n", {"ref": "GenerateThinking_R2"}]}
    outputs:
      - name: UpdatedGenerateThinking
        from: value

  # ラウンド2: 難易度向上（ラウンド1が無効な場合のみ）
  - type: ai
    exec: 22
    id: enhance_prompt_round2
    name: "Round 2: Enhance Prompt Difficulty (Retry)"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    model: qwen3
    system_prompt: |
      あなたは高度なプロンプトエンジニアです。
      与えられたプロンプトをより難易度の高いものに再加工してください。
      ただし、妥当性を損なわないよう注意してください。
      
      難易度向上の方法：
      1. より深い分析や考察を要求する
      2. 複数の視点からの検討を求める
      3. 制約条件や追加の要求を加える
      4. 専門的な知識や論理的思考を必要とする要素を追加
      
      重要：難易度を高めたプロンプトは必ず <prompt>...</prompt> タグで囲むこと
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <prompt>難易度を高めたプロンプト内容</prompt>
    prompts:
      - |
        以下のプロンプトの難易度を高めてください：
        （これは2回目の試行です）
        
        元のプロンプト: {GeneratedPrompt_R2}
    outputs:
      - name: EnhancedPrompt_R2
        select: tag
        tag: prompt
      - name: EnhanceThinking_R2
        select: tag
        tag: think
    save_to:
      vars:
        enhanced_prompt: EnhancedPrompt_R2

  # ラウンド2: 強化プロンプトの更新
  - type: logic
    exec: 23
    id: update_enhanced_prompt_round2
    name: "Round 2: Update Enhanced Prompt"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    op: set
    var: all_enhance_thinking
    value: {"concat": [{"var": "all_enhance_thinking"}, "\n\n[Round 2]\n", {"ref": "EnhanceThinking_R2"}]}
    outputs:
      - name: UpdatedEnhanceThinking
        from: value

  # ラウンド2: 妥当性チェック（ラウンド1が無効な場合のみ）
  - type: ai
    exec: 24
    id: validate_prompt_round2
    name: "Round 2: Validate Prompt (Retry)"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    model: qwen3
    system_prompt: |
      あなたはプロンプトの妥当性を評価する専門家です。
      与えられたプロンプトが実際に成立するかどうかを判定してください。
      
      判定基準：
      1. プロンプトが明確で理解可能か
      2. 要求されている内容が実現可能か
      3. 論理的な矛盾がないか
      4. 適切な回答が可能か
      
      判定結果：
      - 成立する場合: <valid>true</valid>
      - 成立しない場合: <valid>false</valid> と <reason>理由</reason>
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <valid>true または false</valid>
      <reason>成立しない場合の理由（成立する場合は空欄可）</reason>
    prompts:
      - |
        以下のプロンプトが実際に成立するかどうかを判定してください：
        （これは2回目の試行です）
        
        プロンプト: {EnhancedPrompt_R2}
    outputs:
      - name: IsValid_R2
        select: tag
        tag: valid
      - name: InvalidReason_R2
        select: tag
        tag: reason
      - name: ValidateThinking_R2
        select: tag
        tag: think

  # ラウンド2: 妥当性判定の処理
  - type: logic
    exec: 25
    id: check_validation_round2
    name: "Round 2: Check Validation Result"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    op: if
    cond:
      or:
        - equals: ["{IsValid_R2}", "true"]
        - contains: ["{IsValid_R2}", "true"]
    then: "valid"
    else: "invalid"
    outputs:
      - name: ValidationStatus_R2
        from: value
      - name: IsPromptValid_R2
        from: boolean

  # ラウンド2: リトライカウント更新
  - type: logic
    exec: 26
    id: increment_retry_round2
    name: "Round 2: Update Retry Count"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    op: set
    var: retry_count
    value: 2
    outputs:
      - name: RetryCount_R2
        from: value

  # ラウンド2: 検証思考の更新
  - type: logic
    exec: 27
    id: update_validate_thinking_round2
    name: "Round 2: Update Validate Thinking"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    op: set
    var: all_validate_thinking
    value: {"concat": [{"var": "all_validate_thinking"}, "\n\n[Round 2]\n", {"ref": "ValidateThinking_R2"}]}
    outputs:
      - name: UpdatedValidateThinking
        from: value

  # ============================================================
  # 最終処理: 結果の統合と回答生成
  # ============================================================

  # 使用するプロンプトを決定（ラウンド1が有効な場合はラウンド1の結果を使用）
  - type: logic
    exec: 30
    id: set_final_prompt_from_round1
    name: "Set Final Prompt from Round 1"
    run_if:
      equals: ["{IsPromptValid_R1}", "True"]
    op: set
    var: final_prompt
    value: {"ref": "EnhancedPrompt"}
    outputs:
      - name: FinalPrompt_R1
        from: value

  # ラウンド1が無効でラウンド2が実行された場合はラウンド2の結果を使用
  - type: logic
    exec: 31
    id: set_final_prompt_from_round2
    name: "Set Final Prompt from Round 2"
    run_if:
      equals: ["{IsPromptValid_R1}", "False"]
    op: set
    var: final_prompt
    value: {"ref": "EnhancedPrompt_R2"}
    outputs:
      - name: FinalPrompt_R2
        from: value

  # 使用するプロンプトを出力
  - type: logic
    exec: 32
    id: get_final_prompt
    name: "Get Final Prompt"
    op: set
    var: final_prompt_output
    value: {"var": "final_prompt"}
    outputs:
      - name: FinalPrompt
        from: value

  # 使用する検証ステータスを出力
  - type: logic
    exec: 33
    id: get_validation_status
    name: "Get Validation Status"
    op: if
    cond:
      equals: ["{IsPromptValid_R1}", "True"]
    then: "{ValidationStatus_R1}"
    else: "{ValidationStatus_R2}"
    outputs:
      - name: ValidationStatus
        from: value

  # 使用する妥当性フラグを出力
  - type: logic
    exec: 34
    id: get_is_valid
    name: "Get IsValid"
    op: if
    cond:
      equals: ["{IsPromptValid_R1}", "True"]
    then: "{IsValid}"
    else: "{IsValid_R2}"
    outputs:
      - name: FinalIsValidOutput
        from: value

  # 使用する生成プロンプトを出力
  - type: logic
    exec: 35
    id: get_generated_prompt
    name: "Get Generated Prompt"
    op: if
    cond:
      equals: ["{IsPromptValid_R1}", "True"]
    then: "{GeneratedPrompt}"
    else: "{GeneratedPrompt_R2}"
    outputs:
      - name: FinalGeneratedPrompt
        from: value

  # 使用する強化プロンプトを出力
  - type: logic
    exec: 36
    id: get_enhanced_prompt
    name: "Get Enhanced Prompt"
    op: if
    cond:
      equals: ["{IsPromptValid_R1}", "True"]
    then: "{EnhancedPrompt}"
    else: "{EnhancedPrompt_R2}"
    outputs:
      - name: FinalEnhancedPrompt
        from: value

  # 最終回答の取得
  - type: ai
    exec: 40
    id: get_final_answer
    name: "Get Final Answer"
    model: qwen3
    system_prompt: |
      あなたは高度な知識と論理的思考能力を持つAIアシスタントです。
      与えられたプロンプトに対して、詳細かつ包括的な回答を提供してください。
      
      回答のガイドライン：
      1. プロンプトの要求を正確に理解する
      2. 論理的で構造化された回答を提供する
      3. 必要に応じて具体例や説明を含める
      4. 回答は <answer>...</answer> タグで囲む
      
      出力形式：
      <think>あなたの思考プロセス</think>
      <answer>詳細な回答内容</answer>
    prompts:
      - |
        以下のプロンプトに回答してください：
        
        {FinalPrompt}
    outputs:
      - name: FinalAnswer
        select: tag
        tag: answer
      - name: AnswerThinking
        select: tag
        tag: think
    save_to:
      vars:
        final_answer: FinalAnswer

  # 結果の整形（外部Pythonファイル使用）
  - type: python
    exec: 50
    id: format_result
    name: "Format Final Result"
    function: format_prompt_evolution
    code_path: ./examples/helpers/format_helpers.py
    inputs:
      original_input: "{input}"
      generated_prompt: "{FinalGeneratedPrompt}"
      enhanced_prompt: "{FinalEnhancedPrompt}"
      is_valid: "{FinalIsValidOutput}"
      final_answer: "{FinalAnswer}"
      generate_thinking: "{all_generate_thinking}"
      enhance_thinking: "{all_enhance_thinking}"
      validate_thinking: "{all_validate_thinking}"
      answer_thinking: "{AnswerThinking}"
      retry_count: "{retry_count}"
    outputs: [FormattedResult]
    use_env: "global"
    ctx_access: ["vars.read"]

  # 終了ブロック
  - type: end
    exec: 100
    reason: "prompt_evolution_completed"
    exit_code: "success"
    final:
      - name: result
        value: "{FormattedResult}"
      - name: original_input
        value: "{input}"
      - name: generated_prompt
        value: "{FinalGeneratedPrompt}"
      - name: enhanced_prompt
        value: "{FinalEnhancedPrompt}"
      - name: validation_status
        value: "{ValidationStatus}"
      - name: final_answer
        value: "{FinalAnswer}"
      - name: total_rounds
        value: "{retry_count}"
    final_mode: "map"
    include_vars:
      - retry_count
      - is_valid
      - final_prompt

# 実行コマンド:
# python -m sdg run --yaml examples/prompt_evolution_agent.yaml --input examples/data/prompt_evolution_input.jsonl --output output.jsonl --save-intermediate